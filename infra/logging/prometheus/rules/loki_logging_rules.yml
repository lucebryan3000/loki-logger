groups:
  - name: loki_logging_v1
    rules:
      # Canonical recording rules used by dashboards, alerts, and machine checks.
      - record: sprint3:targets_up:count
        expr: sum(up)

      - record: sprint3:targets_down:count
        expr: sum(1 - up)

      - record: sprint3:job_up:ratio
        expr: avg by (job) (up)

      - record: sprint3:prometheus_scrape_failures:rate5m
        expr: rate(prometheus_target_scrapes_exceeded_sample_limit_total[5m])

      - record: sprint3:loki_ingestion_errors:rate5m
        expr: >
          (sum(rate(loki_write_dropped_entries_total[5m])) or vector(0))
          + (sum(rate(loki_write_failures_discarded_total[5m])) or vector(0))

      - record: sprint3:loki_ingestion_errors:increase10m
        expr: >
          (sum(increase(loki_write_dropped_entries_total[10m])) or vector(0))
          + (sum(increase(loki_write_failures_discarded_total[10m])) or vector(0))

      - record: sprint3:host_cpu_usage_percent
        expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

      - record: sprint3:host_memory_usage_percent
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

      - record: sprint3:host_disk_usage_percent
        expr: 100 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100

      - record: sprint3:container_cpu_usage_cores:rate5m
        expr: rate(container_cpu_usage_seconds_total{container!="",container!="POD"}[5m])

      - record: sprint3:container_memory_workingset_bytes
        expr: container_memory_working_set_bytes{container!="",container!="POD"}

      - alert: NodeDiskSpaceLow
        expr: sprint3:host_disk_usage_percent > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          runbook_url: "docs/maintenance.md#disk-management"
          summary: "Disk space low (<10%)"
          description: "Filesystem {{ $labels.mountpoint }} on {{ $labels.instance }} is above 90% used."

      - alert: NodeMemoryHigh
        expr: sprint3:host_memory_usage_percent > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          runbook_url: "docs/operations.md#runbooks"
          summary: "Memory usage high (>90%)"
          description: "Host {{ $labels.instance }} memory usage above 90%."

      - alert: NodeCPUHigh
        expr: sprint3:host_cpu_usage_percent > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          runbook_url: "docs/operations.md#runbooks"
          summary: "CPU usage high (>90%)"
          description: "Host {{ $labels.instance }} CPU usage above 90%."

      - alert: AlloyPipelineDrops
        expr: sum(increase(loki_write_dropped_entries_total[10m])) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          runbook_url: "docs/troubleshooting.md#log-ingestion-issues"
          summary: "Alloy/Loki dropped log entries detected"
          description: "Dropped entries observed over 10m window."

      - alert: LokiVolumeUsageHigh
        expr: sum(container_fs_usage_bytes{container_label_com_docker_compose_service="loki"}) > (20 * 1024 * 1024 * 1024)
        for: 10m
        labels:
          severity: warning
        annotations:
          runbook_url: "docs/maintenance.md#disk-management"
          summary: "Loki container storage usage high"
          description: "Loki container fs usage exceeded 20GiB."

name: ${COMPOSE_PROJECT_NAME:-infra_observability}
networks:
  obs:
    name: obs
    driver: bridge
volumes:
  grafana-data: null
  prometheus-data: null
  loki-data: null
  alloy-positions: null
services:
  grafana:
    mem_limit: 1g
    cpus: "0.50"
    security_opt:
    - no-new-privileges=true
    logging:
      driver: json-file
      options:
        max-size: "25m"
        max-file: "5"
    image: ${GRAFANA_IMAGE:-grafana/grafana:11.1.0}
    env_file:
    - ../../.env
    environment:
    - GF_SERVER_HTTP_PORT=3000
    - GF_AUTH_ANONYMOUS_ENABLED=false
    - GF_USERS_ALLOW_SIGN_UP=false
    - GF_SECURITY_COOKIE_SAMESITE=strict
    - GF_SECURITY_COOKIE_SECURE=false
    ports:
    - ${GRAFANA_HOST:-0.0.0.0}:${GRAFANA_PORT:-9001}:3000
    volumes:
    - grafana-data:/var/lib/grafana
    - ./grafana/provisioning:/etc/grafana/provisioning:ro
    - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
    - obs
    depends_on:
    - loki
    - prometheus
    - alert-sink
    healthcheck:
      test:
      - CMD
      - curl
      - -fsS
      - http://127.0.0.1:3000/api/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    restart: unless-stopped
  loki:
    mem_limit: 2g
    cpus: "1.00"
    security_opt:
    - no-new-privileges=true
    ulimits:
      nofile:
        soft: 65536
        hard: 131072
    logging:
      driver: json-file
      options:
        max-size: "25m"
        max-file: "5"
    image: ${LOKI_IMAGE:-grafana/loki:3.0.0}
    command:
    - -config.file=/etc/loki/loki-config.yml
    volumes:
    - loki-data:/loki
    - ./loki-config.yml:/etc/loki/loki-config.yml:ro
    networks:
    - obs
    ports:
    - "${LOKI_HOST:-127.0.0.1}:${LOKI_PORT:-3200}:3100"
    healthcheck:
      test:
      - CMD
      - wget
      - -q
      - -O
      - '-'
      - http://127.0.0.1:3100/ready
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    restart: unless-stopped
  prometheus:
    mem_limit: 2g
    cpus: "1.00"
    security_opt:
    - no-new-privileges=true
    logging:
      driver: json-file
      options:
        max-size: "25m"
        max-file: "5"
    image: ${PROMETHEUS_IMAGE:-prom/prometheus:v2.52.0}
    command:
    - --config.file=/etc/prometheus/prometheus.yml
    - --storage.tsdb.path=/prometheus
    - --storage.tsdb.retention.time=${PROM_RETENTION_TIME:-15d}
    ports:
    - ${PROM_HOST:-0.0.0.0}:${PROM_PORT:-9004}:9090
    volumes:
    - prometheus-data:/prometheus
    - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    - ./prometheus/rules:/etc/prometheus/rules:ro
    networks:
    - obs
    healthcheck:
      test:
      - CMD
      - wget
      - -q
      - -O
      - '-'
      - http://127.0.0.1:9090/-/ready
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    restart: unless-stopped
  host-monitor:
    mem_limit: 1g
    cpus: "1.00"
    security_opt:
    - no-new-privileges=true
    logging:
      driver: json-file
      options:
        max-size: "25m"
        max-file: "5"
    image: ${NODE_EXPORTER_IMAGE:-prom/node-exporter:v1.8.1}
    command:
    - --path.rootfs=/host
    pid: host
    volumes:
    - ${HOST_ROOTFS:-/}:/host:ro,rslave
    networks:
    - obs
    restart: unless-stopped
  alert-sink:
    mem_limit: 128m
    cpus: "0.10"
    security_opt:
    - no-new-privileges=true
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"
    image: hashicorp/http-echo:0.2.3
    command:
    - -listen=:8080
    - -text=ok
    networks:
    - obs
    restart: unless-stopped

  docker-metrics:
    mem_limit: 2g
    cpus: "2.00"
    logging:
      driver: json-file
      options:
        max-size: "25m"
        max-file: "5"
    image: ${CADVISOR_IMAGE:-gcr.io/cadvisor/cadvisor:v0.49.1}
    privileged: true
    devices:
    - ${HOST_KMSG:-/dev/kmsg}:/dev/kmsg
    volumes:
    - ${HOST_ROOTFS:-/}:/rootfs:ro
    - ${HOST_VAR_RUN:-/var/run}:/var/run:rw
    - ${HOST_SYS:-/sys}:/sys:ro
    - ${HOST_VAR_LIB_DOCKER:-/var/lib/docker}:/var/lib/docker:ro
    networks:
    - obs
    restart: unless-stopped
  alloy:
    mem_limit: 1g
    cpus: "0.75"
    security_opt:
    - no-new-privileges=true
    logging:
      driver: json-file
      options:
        max-size: "25m"
        max-file: "5"
    image: ${ALLOY_IMAGE:-grafana/alloy:v1.2.1}
    command:
    - run
    - --server.http.listen-addr=0.0.0.0:12345
    - --storage.path=/var/lib/alloy
    - /etc/alloy/config.alloy
    user: "0:0"
    ports:
    - "127.0.0.1:1514:1514"
    volumes:
    - ${HOST_DOCKER_SOCK:-/var/run/docker.sock}:/var/run/docker.sock:ro
    - ${HOST_VAR_LOG_JOURNAL:-/var/log/journal}:/var/log/journal:ro
    - ${HOST_RUN_LOG_JOURNAL:-/run/log/journal}:/run/log/journal:ro
    - ${HOST_HOME:-/home/luce}:/host/home:ro
    - ${HOST_VAR_LOG:-/var/log}:/host/var/log:ro
    - ./alloy-config.alloy:/etc/alloy/config.alloy:ro
    - alloy-positions:/var/lib/alloy
    networks:
    - obs
    depends_on:
    - loki
    healthcheck:
      test:
      - CMD
      - bash
      - -ec
      - 'exec 3<>/dev/tcp/127.0.0.1/12345; printf "GET /-/ready HTTP/1.0\r\n\r\n" >&3; head -n 1 <&3 | grep -q "200"'
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

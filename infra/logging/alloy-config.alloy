logging {
  level = "info"
}

discovery.docker "all" {
  host = "unix:///var/run/docker.sock"
}

discovery.relabel "docker_filtered" {
  targets = discovery.docker.all.targets

  // Keep only selected compose projects (bounded allowlist):
  // - vllm (includes codeswarm-mcp)
  // - hex  (includes hex-atlas-*)
  rule {
    action        = "keep"
    source_labels = ["__meta_docker_container_label_com_docker_compose_project"]
    regex         = "^(vllm|hex)$"
  }

  // Explicitly drop the logging stack even if keep rules are expanded later.
  rule {
    action        = "drop"
    source_labels = ["__meta_docker_container_label_com_docker_compose_project"]
    regex         = "^logging$"
  }

  // --- label schema (Sprint-3 Phase 2) ---
  // Stable low-cardinality labels derived from compose metadata.
  // stack = compose project (vllm|hex)
  rule {
    action        = "replace"
    source_labels = ["__meta_docker_container_label_com_docker_compose_project"]
    target_label  = "stack"
  }

  // service = compose service (bounded by compose)
  rule {
    action        = "replace"
    source_labels = ["__meta_docker_container_label_com_docker_compose_service"]
    target_label  = "service"
  }

  // source_type = docker (constant)
  rule {
    action        = "replace"
    source_labels = ["__address__"]
    target_label  = "source_type"
    regex         = ".*"
    replacement   = "docker"
  }
  // --- end label schema ---

}


loki.source.docker "dockerlogs" {
  host       = "unix:///var/run/docker.sock"
  targets    = discovery.relabel.docker_filtered.output
  forward_to = [loki.process.docker.receiver]
}

// journald -> Loki (optional)
loki.source.journal "journald" {
  forward_to = [loki.process.journald.receiver]
}

// rsyslog TCP syslog ingress (localhost port mapping on host)
loki.source.syslog "rsyslog" {
  listener {
    address  = "0.0.0.0:1514"
    protocol = "tcp"
    labels = {
      log_source  = "rsyslog_syslog",
      source_type = "syslog",
    }
  }

  // Route through main processor so syslog also gets shared static labels
  // and redaction stages before write.
  forward_to = [loki.process.main.receiver]
}

// tool sink
local.file_match "tool_sink" {
  path_targets = [{ "__path__" = "/host/home/luce/_logs/*.log" }]
}
loki.source.file "tool_sink" {
  targets       = local.file_match.tool_sink.targets
  tail_from_end = true
  forward_to    = [loki.process.tool_sink.receiver]
}

// telemetry
local.file_match "telemetry" {
  path_targets = [{ "__path__" = "/host/home/luce/_telemetry/*.jsonl" }]
}
loki.source.file "telemetry" {
  targets       = local.file_match.telemetry.targets
  tail_from_end = true
  forward_to    = [loki.process.telemetry.receiver]
}

// GPU telemetry (host nvidia-smi CSV mirror)
local.file_match "gpu_telemetry_gpu" {
  path_targets = [{ "__path__" = "/host/home/luce/_telemetry/gpu/gpu-live.csv" }]
}

loki.source.file "gpu_telemetry_gpu" {
  targets       = local.file_match.gpu_telemetry_gpu.targets
  tail_from_end = true
  forward_to    = [loki.process.gpu_telemetry_gpu.receiver]
}

local.file_match "gpu_telemetry_proc" {
  path_targets = [{ "__path__" = "/host/home/luce/_telemetry/gpu/gpu-proc.csv" }]
}

loki.source.file "gpu_telemetry_proc" {
  targets       = local.file_match.gpu_telemetry_proc.targets
  tail_from_end = true
  forward_to    = [loki.process.gpu_telemetry_proc.receiver]
}

// --- NVIDIA telemetry-as-logs (Sprint-3 Phase 4a) ---
local.file_match "nvidia_telem" {
  path_targets = [
    { "__path__" = "/host/home/luce/apps/vLLM/logs/telemetry/nvidia/raw-30s.jsonl" },
    { "__path__" = "/host/home/luce/apps/vLLM/logs/telemetry/nvidia/raw-60s.jsonl" },
    { "__path__" = "/host/home/luce/apps/vLLM/logs/telemetry/nvidia/proc-5m.jsonl" },
    { "__path__" = "/host/home/luce/apps/vLLM/logs/telemetry/nvidia/health-15m.jsonl" },
    { "__path__" = "/host/home/luce/apps/vLLM/logs/telemetry/nvidia/alerts.jsonl" },
    { "__path__" = "/host/home/luce/apps/vLLM/logs/telemetry/nvidia/burst/*.jsonl" },
  ]
}

loki.source.file "nvidia_telem" {
  targets       = local.file_match.nvidia_telem.targets
  tail_from_end = true
  forward_to    = [loki.process.nvidia_telem.receiver]
}

loki.process "nvidia_telem" {
  stage.static_labels {
    values = {
      env         = "sandbox",
      stack       = "vllm",
      service     = "vllm",
      source_type = "file",
      log_source  = "nvidia_telem",
      telemetry_tier = "raw30",
    }
  }

  // --- redaction (phase 7b remediation) ---
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]
}
// --- end NVIDIA telemetry-as-logs ---


// CodeSwarm MCP logs (vLLM host bind)
local.file_match "codeswarm_mcp" {
  path_targets = [{ "__path__" = "/host/home/luce/apps/vLLM/_data/mcp-logs/*.log" }]
}


loki.source.file "codeswarm_mcp" {
  targets       = local.file_match.codeswarm_mcp.targets
  tail_from_end = true
  forward_to    = [loki.process.codeswarm.receiver]
}

// --- VS Code Server logs ---
local.file_match "vscode_server" {
  path_targets = [
    { "__path__" = "/host/home/luce/.vscode-server/**/*.log" },
    { "__path__" = "/host/home/luce/.vscode-server/**/log.txt" },
  ]
}

loki.source.file "vscode_server" {
  targets       = local.file_match.vscode_server.targets
  tail_from_end = true
  forward_to    = [loki.process.vscode.receiver]
}
// --- end VS Code Server logs ---

// --- Codex TUI logs ---
local.file_match "codex_tui" {
  path_targets = [{ "__path__" = "/host/home/luce/.codex/log/codex-tui.log" }]
}

loki.source.file "codex_tui" {
  targets       = local.file_match.codex_tui.targets
  tail_from_end = true
  forward_to    = [loki.process.codex_tui.receiver]
}
// --- end Codex TUI logs ---

// --- Host file logs (selected) ---
local.file_match "host_wireguard_log" {
  path_targets = [{ "__path__" = "/host/var/log/wireguard-client-manager.log" }]
}

loki.source.file "host_wireguard_log" {
  targets       = local.file_match.host_wireguard_log.targets
  tail_from_end = true
  forward_to    = [loki.process.host_wireguard_log.receiver]
}

local.file_match "host_codeswarm_log" {
  path_targets = [{ "__path__" = "/host/var/log/codeswarm.log" }]
}

loki.source.file "host_codeswarm_log" {
  targets       = local.file_match.host_codeswarm_log.targets
  tail_from_end = true
  forward_to    = [loki.process.host_codeswarm_log.receiver]
}

local.file_match "host_apt_history" {
  path_targets = [{ "__path__" = "/host/var/log/apt/history.log" }]
}

loki.source.file "host_apt_history" {
  targets       = local.file_match.host_apt_history.targets
  tail_from_end = true
  forward_to    = [loki.process.host_apt_history.receiver]
}
// --- end Host file logs (selected) ---

 loki.process "main" {
  stage.static_labels {
    values = {
      env            = "sandbox",
      syslog_channel = "general",
      syslog_level   = "info",
    }
  }

  // syslog channel tagging for better security triage in Grafana/Loki.
  stage.match {
    selector = "{source_type=\"syslog\"} |~ \"(?i)ufw\""
    stage.static_labels {
      values = {
        syslog_channel  = "ufw",
        security_domain = "firewall",
      }
    }
  }

  stage.match {
    selector = "{source_type=\"syslog\"} |~ \"(?i)(pam_unix|sshd|sudo:|authentication failure|session opened for user|session closed for user)\""
    stage.static_labels {
      values = {
        syslog_channel  = "auth",
        security_domain = "auth",
      }
    }
  }

  stage.match {
    selector = "{source_type=\"syslog\"} |~ \"(?i)(warn|warning|degraded|retry|backoff|throttl)\""
    stage.static_labels {
      values = {
        syslog_level = "warn",
      }
    }
  }

  stage.match {
    selector = "{source_type=\"syslog\"} |~ \"(?i)(error|err|fatal|panic|fail|failed|exit-code|denied|refused|operation not permitted|segfault|oom|timeout)\""
    stage.static_labels {
      values = {
        syslog_level = "error",
      }
    }
  }

  // Prefer structured syslog severity label when available.
  stage.match {
    selector = "{source_type=\"syslog\",level=~\"(?i)(warn|warning)\"}"
    stage.static_labels {
      values = {
        syslog_level = "warn",
      }
    }
  }

  stage.match {
    selector = "{source_type=\"syslog\",level=~\"(?i)(err|error|crit|critical|alert|emerg|fatal|panic)\"}"
    stage.static_labels {
      values = {
        syslog_level = "error",
      }
    }
  }

  // Improve service attribution for syslog lines that include systemd unit names.
  stage.match {
    selector = "{source_type=\"syslog\"} |~ \"[A-Za-z0-9_.@-]+[.]service\""
    stage.regex {
      expression = "(?P<syslog_service>[A-Za-z0-9_.@-]+[.]service)"
    }
    stage.labels {
      values = {
        service_name = "syslog_service",
      }
    }
  }

  // --- redaction (Sprint-3 Phase 1) ---
  // Fake-secret patterns only; prevent credentials from being stored in Loki.
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]

}

loki.process "codeswarm" {
  stage.static_labels {
    values = {
      env        = "sandbox",
      log_source = "codeswarm_mcp",
    }
  }

  // --- safe JSON parsing (Sprint-3 Phase 3) ---
  // Parse JSON lines; do not drop malformed lines.
  stage.json {
    expressions = {
      mcp_kind  = "kind",
      mcp_tool  = "tool",
      mcp_level = "level",
    }
  }

  // Promote only bounded fields to labels (selected via live probe; <=20 unique values).
  stage.labels {
    values = {
      mcp_kind  = "mcp_kind",
      mcp_tool  = "mcp_tool",
      mcp_level = "mcp_level",
    }
  }
  // --- end safe JSON parsing ---

  // --- redaction (Sprint-3 Phase 1) ---
  // Fake-secret patterns only; prevent credentials from being stored in Loki.
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]
}

// --- VS Code Server processor ---
loki.process "vscode" {
  stage.static_labels {
    values = {
      env        = "sandbox",
      log_source = "vscode_server",
    }
  }

  // Redaction â€” same patterns as main/codeswarm processors
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }

  forward_to = [loki.write.default.receiver]
}
// --- end VS Code Server processor ---

// --- Docker processor ---
loki.process "docker" {
  stage.static_labels {
    values = {
      env        = "sandbox",
      log_source = "docker",
    }
  }

  // --- redaction ---
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]
}

// --- Journald processor ---
loki.process "journald" {
  stage.static_labels {
    values = {
      env        = "sandbox",
      log_source = "journald",
    }
  }

  // --- redaction ---
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]
}

// --- Tool Sink processor ---
loki.process "tool_sink" {
  stage.static_labels {
    values = {
      env        = "sandbox",
      log_source = "tool_sink",
    }
  }

  // --- redaction ---
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]
}

// --- Telemetry processor ---
loki.process "telemetry" {
  stage.static_labels {
    values = {
      env        = "sandbox",
      log_source = "telemetry",
    }
  }

  // --- redaction ---
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]
}

// --- Codex TUI processor ---
loki.process "codex_tui" {
  stage.static_labels {
    values = {
      env         = "sandbox",
      log_source  = "codex_tui",
      source_type = "file",
    }
  }

  // --- redaction ---
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]
}
// --- end Codex TUI processor ---

// --- Host wireguard log processor ---
loki.process "host_wireguard_log" {
  stage.static_labels {
    values = {
      env         = "sandbox",
      log_source  = "host_wireguard",
      source_type = "file",
    }
  }

  // --- redaction ---
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]
}
// --- end Host wireguard log processor ---

// --- Host codeswarm log processor ---
loki.process "host_codeswarm_log" {
  stage.static_labels {
    values = {
      env         = "sandbox",
      log_source  = "host_codeswarm",
      source_type = "file",
    }
  }

  // --- redaction ---
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]
}
// --- end Host codeswarm log processor ---

// --- Host apt history processor ---
loki.process "host_apt_history" {
  stage.static_labels {
    values = {
      env         = "sandbox",
      log_source  = "host_apt",
      source_type = "file",
    }
  }

  // --- redaction ---
  stage.replace {
    expression = "(?i)\\bbearer\\s+([A-Za-z0-9._~-]+)\\b"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bcookie\\s*[:=]\\s*([^;\\s\\r\\n]+)"
    replace    = "[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\bapi[_-]?key\\s*[:=]\\s*([A-Za-z0-9._~-]+)"
    replace    = "[REDACTED]"
  }
  // --- end redaction ---

  forward_to = [loki.write.default.receiver]
}
// --- end Host apt history processor ---

// --- GPU telemetry processors ---
loki.process "gpu_telemetry_gpu" {
  stage.regex {
    expression = "^[^,]+,(?P<gpu_name>[^,]+),(?P<gpu_util>[0-9.]+),(?P<memory_pct>[0-9.]+),(?P<memory_used_mib>[0-9.]+),(?P<memory_total_mib>[0-9.]+),(?P<temp_c>[0-9.]+),(?P<power_w>[0-9.]+)$"
  }

  stage.labels {
    values = {
      gpu_name = "gpu_name",
    }
  }

  stage.static_labels {
    values = {
      env         = "sandbox",
      log_source  = "gpu_telemetry",
      source_type = "gpu_csv",
      host        = "codeswarm",
      stream      = "gpu",
    }
  }

  forward_to = [loki.write.default.receiver]
}

loki.process "gpu_telemetry_proc" {
  stage.regex {
    expression = "^[^,]+,(?P<pid>[0-9]+),(?P<process_name>[^,]+),(?P<used_gpu_memory_mib>[0-9.]+)$"
  }

  stage.static_labels {
    values = {
      env         = "sandbox",
      log_source  = "gpu_telemetry",
      source_type = "gpu_csv",
      host        = "codeswarm",
      stream      = "proc",
    }
  }

  forward_to = [loki.write.default.receiver]
}

loki.write "default" {
  endpoint {
    url = "http://loki:3100/loki/api/v1/push"
  }
}

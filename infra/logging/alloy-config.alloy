logging {
  level = "info"
}

discovery.docker "all" {
  host = "unix:///var/run/docker.sock"
}

discovery.relabel "docker_filtered" {
  targets = discovery.docker.all.targets

  // Keep only selected compose projects (bounded allowlist):
  // - vllm (includes codeswarm-mcp)
  // - hex  (includes hex-atlas-*)
  rule {
    action        = "keep"
    source_labels = ["__meta_docker_container_label_com_docker_compose_project"]
    regex         = "^(vllm|hex)$"
  }

  // Explicitly drop the logging stack even if keep rules are expanded later.
  rule {
    action        = "drop"
    source_labels = ["__meta_docker_container_label_com_docker_compose_project"]
    regex         = "^logging$"
  }

  // --- label schema (Sprint-3 Phase 2) ---
  // Stable low-cardinality labels derived from compose metadata.
  // stack = compose project (vllm|hex)
  rule {
    action        = "replace"
    source_labels = ["__meta_docker_container_label_com_docker_compose_project"]
    target_label  = "stack"
  }

  // service = compose service (bounded by compose)
  rule {
    action        = "replace"
    source_labels = ["__meta_docker_container_label_com_docker_compose_service"]
    target_label  = "service"
  }

  // source_type = docker (constant)
  rule {
    action        = "replace"
    source_labels = ["__address__"]
    target_label  = "source_type"
    regex         = ".*"
    replacement   = "docker"
  }
  // --- end label schema ---

}


loki.source.docker "dockerlogs" {
  host       = "unix:///var/run/docker.sock"
  targets    = discovery.relabel.docker_filtered.output
  forward_to = [loki.process.main.receiver]
}

// journald -> Loki (optional)
loki.source.journal "journald" {
  forward_to = [loki.process.main.receiver]
}

// tool sink
local.file_match "tool_sink" {
  path_targets = [{ "__path__" = "/host/home/luce/_logs/*.log" }]
}
loki.source.file "tool_sink" {
  targets       = local.file_match.tool_sink.targets
  tail_from_end = true
  forward_to    = [loki.process.main.receiver]
}

// telemetry
local.file_match "telemetry" {
  path_targets = [{ "__path__" = "/host/home/luce/_telemetry/*.jsonl" }]
}
loki.source.file "telemetry" {
  targets       = local.file_match.telemetry.targets
  tail_from_end = true
  forward_to    = [loki.process.main.receiver]
}

// CodeSwarm MCP logs (vLLM host bind)
local.file_match "codeswarm_mcp" {
  path_targets = [{ "__path__" = "/host/home/luce/apps/vLLM/_data/mcp-logs/*.log" }]
}


loki.source.file "codeswarm_mcp" {
  targets       = local.file_match.codeswarm_mcp.targets
  tail_from_end = true
  forward_to    = [loki.process.codeswarm.receiver]
}

 loki.process "main" {
  stage.static_labels {
    values = {
      env = "sandbox",
    }
  }
  forward_to = [loki.write.default.receiver]

  // --- redaction (Sprint-3 Phase 1) ---
  // Fake-secret patterns only; prevent credentials from being stored in Loki.
  stage.replace {
    expression = "(?i)\\b(bearer\\s+)[A-Za-z0-9._~-]+\\b"
    replace    = "$1[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\b(cookie\\s*[:=]\\s*)[^;\\s\\r\\n]+"
    replace    = "$1[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\b(api[_-]?key\\s*[:=]\\s*)[A-Za-z0-9._~-]+"
    replace    = "$1[REDACTED]"
  }
  // --- end redaction ---


}

loki.process "codeswarm" {
  stage.static_labels {
    values = {
      env        = "sandbox",
      log_source = "codeswarm_mcp",
    }
  }
  forward_to = [loki.write.default.receiver]

  // --- redaction (Sprint-3 Phase 1) ---
  // Fake-secret patterns only; prevent credentials from being stored in Loki.
  stage.replace {
    expression = "(?i)\\b(bearer\\s+)[A-Za-z0-9._~-]+\\b"
    replace    = "$1[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\b(cookie\\s*[:=]\\s*)[^;\\s\\r\\n]+"
    replace    = "$1[REDACTED]"
  }
  stage.replace {
    expression = "(?i)\\b(api[_-]?key\\s*[:=]\\s*)[A-Za-z0-9._~-]+"
    replace    = "$1[REDACTED]"
  }
  // --- end redaction ---


}

loki.write "default" {
  endpoint {
    url = "http://loki:3100/loki/api/v1/push"
  }
}

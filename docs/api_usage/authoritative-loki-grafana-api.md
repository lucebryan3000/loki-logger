# Authoritative Loki + Grafana API Usage

Comprehensive API usage reference for querying logs from applications, based on official Grafana and Loki documentation.

## What To Query

For log retrieval and search:
- Use **Loki HTTP API** directly when your app can reach Loki.
- Use **Grafana HTTP API** (`/api/ds/query`) when your app only has Grafana access, or must use Grafana RBAC and data source abstraction.

## Loki HTTP API (Primary for Logs)

Loki's query endpoints execute LogQL expressions and return streams or metric vectors depending on query type.

### Base Endpoints

- `GET|POST /loki/api/v1/query` — instant query
- `GET|POST /loki/api/v1/query_range` — range query
- `GET /loki/api/v1/labels` — list label keys
- `GET /loki/api/v1/label/<name>/values` — list values for one label
- `GET /loki/api/v1/series` — list streams matching label selectors
- `POST /loki/api/v1/push` — ingest logs
- `GET /ready` — readiness probe

### `query` vs `query_range`

- `query`: evaluates at one time (`time` param optional).
- `query_range`: evaluates over a time window (`start`/`end`, or `since`), supports step/interval controls.

### Common Query Parameters

`query`:
- `query` (required): LogQL expression
- `time` (optional): evaluation timestamp
- `limit` (optional): max entries returned
- `direction` (optional): `backward` or `forward`

`query_range`:
- `query` (required): LogQL expression
- `start`, `end` (optional): time window boundaries
- `since` (optional): shorthand window when `start` is omitted
- `step` (optional): step width for metric queries
- `interval` (optional): log-entry spacing for stream queries
- `limit` (optional): max entries returned
- `direction` (optional): `backward` or `forward`

### Timestamp Formats

Loki accepts multiple timestamp forms on these endpoints, including:
- Unix nanoseconds
- RFC3339
- RFC3339Nano

### Example (Direct Loki)

```bash
curl -G "http://<loki-host>:3100/loki/api/v1/query_range" \
  --data-urlencode 'query={job="api"} |= "Cannot find module"' \
  --data-urlencode 'start=2026-02-19T00:00:00Z' \
  --data-urlencode 'end=2026-02-19T23:59:59Z' \
  --data-urlencode 'limit=500' \
  --data-urlencode 'direction=backward'
```

## Grafana HTTP API (Datasource Proxy Pattern)

Grafana can execute data source queries over `/api/ds/query`.

### Base Endpoint

- `POST /api/ds/query` — execute queries against one or more data sources

### Request Shape

Top-level fields typically include:
- `from` / `to` (epoch ms time bounds)
- `queries` (array of datasource-specific query objects)

Each query object includes:
- `datasource.uid` (or equivalent datasource selector)
- `refId` (query ID like `A`, `B`)
- Query payload understood by the datasource plugin (for Loki, this carries LogQL expression fields)

### Example (Grafana Datasource Query)

```bash
curl -sS -X POST "http://<grafana-host>/api/ds/query" \
  -H "Authorization: Bearer <grafana-service-account-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "from":"1739923200000",
    "to":"1740009599000",
    "queries":[
      {
        "refId":"A",
        "datasource":{"uid":"<loki-datasource-uid>"},
        "expr":"{job=\"api\"} |= \"Cannot find module\"",
        "queryType":"range"
      }
    ]
  }'
```

Note:
- Exact query object shape can vary by datasource plugin and Grafana version.
- For Loki-specific query payload details, inspect request payloads generated by Grafana Explore in browser dev tools and mirror that structure in your app.

## Authentication and Authorization

### Loki

- Loki itself does not ship with a built-in auth layer; operators commonly place an authenticating reverse proxy in front.
- In multi-tenant deployments, requests must include tenant context (commonly `X-Scope-OrgID`).

### Grafana

Officially documented auth options for HTTP API include:
- Basic auth
- Service account token (`Authorization: Bearer <token>`)
- Session cookie auth

For app-to-app integration, use service account tokens.

## Query Construction Guidance (LogQL)

Use LogQL to narrow scope early and reduce query cost:
- Start with precise label selectors (for example `{env="prod", service="api"}`)
- Then add line filters (`|=`, `!=`, `|~`, `!~`)
- Use parser stages (`| json`, `| logfmt`) only when needed

Good:

```logql
{env="prod", service="api"} |= "Cannot find module"
```

Less efficient:

```logql
{env=~".+"} |= "Cannot find module"
```

## Decision Matrix

Use Loki direct when:
- Your app can reach Loki network endpoint
- You want least overhead and clearest API contract for logs
- You control tenancy/auth at network/proxy layer

Use Grafana API when:
- Loki is not directly reachable
- You need Grafana RBAC/service account controls
- You need one API surface for mixed datasources (Loki + Prometheus + others)

## Error Handling Expectations

At minimum, clients should:
- Treat non-2xx HTTP status as query failure
- Capture and log response body for diagnosis
- Enforce request timeout and retry policy with backoff
- Validate response `status`/data shape before parsing results

## Official Sources

Checked on **2026-02-19**:

- Loki HTTP API: <https://grafana.com/docs/loki/latest/reference/loki-http-api/>
- Loki query language (LogQL): <https://grafana.com/docs/loki/latest/query/>
- Loki authentication: <https://grafana.com/docs/loki/latest/operations/authentication/>
- Loki multi-tenancy: <https://grafana.com/docs/loki/latest/operations/multi-tenancy/>
- Grafana HTTP API overview: <https://grafana.com/docs/grafana/latest/developers/http_api/>
- Grafana HTTP API authentication: <https://grafana.com/docs/grafana/latest/developers/http_api/auth/>
- Grafana data source query API: <https://grafana.com/docs/grafana/latest/developers/http_api/data_source/#query-a-data-source>
